<html>

<head>
	<meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
	<link rel="stylesheet" href="https://unpkg.com/leaflet@1.2.0/dist/leaflet.css" integrity="sha512-M2wvCLH6DSRazYeZRIm1JnYyh22purTM+FDB5CsyxtQJYeKq83arPe5wgbNmcFXGqiSH2XR8dT/fJISVA1r/zQ=="
	 crossorigin="" />
	<script src="https://unpkg.com/leaflet@1.2.0/dist/leaflet.js" integrity="sha512-lInM/apFSqyy1o6s89K4iQUKg6ppXEgsVxT35HbzUupEVRh2Eu9Wdl4tHj7dZO0s1uvplcYGmt3498TtHq+log=="
	 crossorigin=""></script>


	 <!-- Latest compiled and minified CSS -->
<!-- <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
 -->
 	 <link rel="stylesheet" href="https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/css/bootstrap.css">
	<script src="http://d3js.org/d3.v4.min.js"></script>
	<!-- <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script> -->
	
	<style type="text/css">
	      body
      {
        background-color: black;
      }
      
      .carousel
      {
        height: 700px;
        background-color: black;
      }
      .carousel-caption h1 
      {
        font-size: 50px;
      }
      
		/*.jumbotron {
    background-image: url("background.jpg") !important; 
}	
		.vertical-center {
		  height:100%;
		  width:100%;

		  text-align: center;  /* align the inline(-block) elements horizontally */
		  font: 0/0 a;         /* remove the gap between inline(-block) elements */
		}*/

		rect.info {
		  fill: steelblue;
		}

		#mapid {
			height: 800px;
		}

		.info {
			padding: 6px 8px;
			font: 14px/16px Arial, Helvetica, sans-serif;
			background: white;
			background: rgba(255, 255, 255, 0.8);
			box-shadow: 0 0 15px rgba(0, 0, 0, 0.2);
			border-radius: 5px;
		}

		.info h4 {
			margin: 0 0 5px;
			color: #777;
		}

		.legend {
			line-height: 18px;
			color: #555;
		}

		.legend i {
			width: 18px;
			height: 18px;
			float: left;
			margin-right: 8px;
			opacity: 0.7;
		}

		.bar {
			fill: steelblue;
		}

		.bar:hover {
			fill: brown;
		}

		.axis,
		.legend-bar, .legend_pie {
			font: 10px sans-serif;
			fill: white;
		}

		.axis text{
			fill: white;
		}

		.axis path,
		.axis line {
			fill: none;
			stroke: #FFF;
			shape-rendering: crispEdges;
		}

		.x.axis path {
			display: none;
		}

		#tooltip-pie, #tooltip-bar, #tooltip-chart {
		    position: absolute;
		    width: 150px;
		    height: auto;
		    padding: 10px;
		    z-index: 10;
		    background-color: white;
		    -webkit-border-radius: 10px;
		    -moz-border-radius: 10px;
		    border-radius: 10px;
		    -webkit-box-shadow: 4px 4px 10px rgba(0, 0, 0, 0.4);
		    -mox-box-shadow: 4px 4px 4px 10px rgba(0, 0, 0, 0.4);
		    box-shadow: 4px 4px 10px rbga(0, 0, 0, 0.4) pointer-events: none;
		}

		#jumbotron-row{
			margin-top: 350px;
		}

		#jumbotron-row h1, #jumbotron-row h3, #jumbotron-row h4, #jumbotron-row p a{
			color: white;
		}

		.padding-0{
		    padding-right:0;
		    padding-left:0;
		}

		.line {
		  fill: none;
		  stroke: #008000;
		  stroke-width: 2px;
		}
		/*#tooltip-pie.hidden, #tooltip-chart.hidden, #tooltip-bar.hidden {
	      display: none;
	    }*/

	</style>
</head>

<body>

<div class="container">
	<div id="tooltip-pie" ></div>
	<div id="tooltip-chart"></div>
	<div id="tooltip-bar" ></div>
	 <div class="container">
      <div class="row">
        <div class="col-xs-12 col-sm-12 col-md-12 col-lg-12 col-xl-12">
          <br />
 
          <div id="carousel-example-generic" class="carousel slide" data-ride="carousel">
            <ol class="carousel-indicators">
              <li data-target="#carousel-example-generic" data-slide-to="0" class="active"></li>
              <li data-target="#carousel-example-generic" data-slide-to="1"></li>
              <li data-target="#carousel-example-generic" data-slide-to="2"></li>
            </ol>
 
            <div class="carousel-inner" role="listbox">
              <div class="carousel-item active">
                <img src="background.jpg" alt="First Slide" />
                <div class="carousel-caption">
                  <h1>Factors impacting Airbnb Rentals</h1>
                  <h3>Team - Mind Benders</h3>
                  <p><a class="btn btn-lg btn-primary" href="#map_type" role="button">Explore Los Angeles</a></p>
                </div>
              </div>
 
              <div class="carousel-item">
               <img src="la.jpg" width="1200px" height="650px" alt="Second Slide" />

                <div class="carousel-caption">
                 <!--  <h2>Founded in 2008, Airbnb has been increasing and growing
dramatically and has served more than 150 million guests through over 3 million listings in more than
190 countries in less than a decade</h2> -->
                  <p><a class="btn btn-lg btn-danger" href="#map_type" role="button">Explore Los Angeles</a></p>
                </div>
              </div>
 
              <div class="carousel-item">
                <img src="logo.png" width="1200px" height="700px" alt="Third Slide" />
                <div class="carousel-caption">
                	<h3>About the Project</h3>
                	<p>Founded in 2008, Airbnb has been increasing and growing
dramatically and has served more than 150 million guests through over 3 million listings in more than
190 countries in less than a decade.</p>
<p>We explore the factors affecting Airbnb prices in Los Angeles County and determine which factors significantly affect the prices. We then represent them visually in the form of maps, bar charts and pie charts so that our target audience (any guest/potential host) can easily choose where they would want to reside when planning a trip or decide which place if rented out would ensure a higher profit margin.</p>
					<h3>Team Members</h3>
					<h5>Onzali Suba</h5>
					<h5>Tejal Patted</h5>
					<h5>Nitya Pydipati</h5>

                </div>
              </div>
            </div>
 
            <a class="left carousel-control" href="#carousel-example-generic" role="button" data-slide="prev">
              <span class="icon-prev" aria-hidden="true"></span>
              <span class="sr-only">Previous</span>
            </a>
 
            <a class="right carousel-control" href="#carousel-example-generic" role="button" data-slide="next">
              <span class="icon-next" aria-hidden="true"></span>
              <span class="sr-only">Next</span>
            </a>
          </div>
        </div>
      </div>
    </div>
	<!-- <div class="jumbotron theme-showcase vertical-center" id="jumbotron" role="main">
		<div id="jumbotron-row">
			<h1>Factors impacting Airbnb Rentals</h1>
			<h3>Team - Mind Benders</h3>
			<h4>Tejal Patted</h4>
			<h4>Onzali Suba</h4>
			<h4>Nitya Pydipati</h4>
			<p><a class="btn btn-lg btn-success" href="#map_type_choose" role="button">Explore Los Angeles</a></p>
		</div>
	</div> -->
	
	<!-- <h3 id="map_type_choose" style="color:white"> Choose among the options below to view corresponding chloropleth map </h3> -->
	<div>
		<select id="map_type" style="width: 200px;">
			<option value="Crime">Crime</option>
			<option value="Income">Income</option>
		</select>
	</div>
	<br/>
	<div class="row">
	    <div class="col-sm-9 padding-0"" >
	    <!--   <div style="background-color: white; height: 50px;"><center><h3 style="color: blue;"> Chloropleth map </h3></center></div> -->
	      <div id="mapid" style="margin-left: 15px;"></div>
	    </div>
	    <div class="col-sm-3 padding-0"">
	      <div>
	      	<center><h3 id="info-city" style="color:white">Long Beach</h3></center>
	      	<center><h5 style="color:white">Crime rate by type</h5></center>
	      	<svg class='chart'></svg>
	      	<center><h5 style="color:white">Room Type</h5></center>
	      	<center><svg id="pie"></svg></center>
	      </div>
	    </div>
  	</div>	
  	<div class="container">
	  	<div class="row" >
	  		<div class="col-sm-12">
	  			<svg class="corr_chart"></svg>
	  		</div>
	  	</div>
  	</div>
</div>
	<script type="text/javascript">

		d3.select("#tooltip-chart").style("visibility","hidden");
		d3.select("#tooltip-pie").style("visibility","hidden");
		d3.select("#tooltip-bar").style("visibility","hidden");

		var infoData={"set": "/1.0/boundary-set/la-county-neighborhoods-current/", "zipcodes": [90740, 90804, 90805, 90806, 90807, 90801, 90802, 90803, 90840, 90842, 90832, 90808, 90809, 90846, 90847, 90844, 90822, 90853, 90833, 90848, 90813, 90834, 90810, 90831, 90815, 90814, 90835, 90899], "entire_home_apt": 581.0, "norm_crime_count": 13.98, "crime_count": 601.0, "narcotics": 114.0, "fraud_and_nsf_checks": 19.0, "federal_offenses": 2.0, "income": 105.57, "price_per_room": 96.87, "metadata": {"sqmi": 52.1003673205, "type": "standalone-city", "name": "Long Beach", "slug": "long-beach"}, "private_room": 425.0, "burglary": 73.0, "slug": "long-beach-la-county-neighborhood-current", "larceny_theft": 196.0, "felonies_miscellaneous": 10.0, "kind": "L.A. County Neighborhood (Current)", "shared_room": 74.0, "name": "Long Beach", "arson": 3.0, "sex_offenses": 15.0, "robbery": 53.0, "external_id": "long-beach", "grand_theft_auto": 109.0, "resource_uri": "/1.0/boundary/long-beach-la-county-neighborhood-current/"};
		var inc_count = [];
		var barData = [{ name: "Rancho Palos Verdes", crime_count: 605, price_per_room: 108.06, income: 108.88 }, { name: "Lakewood", crime_count: 3146, price_per_room: 75.96, income: 92.10 },
		{ name: "Carson", crime_count: 3210, price_per_room: 84.52, income: 102.83 }];
		var markers_listings=[]

		var pie_data = [];
		

		d3.json("la.geojson", function (data) {

			// L.geoJson function is used to parse geojson file and load on to map
			var mymap = L.map('mapid').setView([34.0522, -118.2437], 10);
			// var mymap = L.map('mapid').setView([51.505, -0.09], 13);
			L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token={accessToken}', {
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a>',
				maxZoom: 18,
				id: 'mapbox.satellite',
				accessToken: 'pk.eyJ1Ijoib3N1YmEiLCJhIjoiY2phMGluZnQ0MzVpejJwcG8zM2pqdzY0OCJ9.9TdOSdm8ZeQ599APXk1Jiw'
			}).addTo(mymap);

			var myStyle = {
				"weight": 1,
				"opacity": 0.55
			};

			L.geoJSON(data, {
				style: myStyle
			}).addTo(mymap);

		
			function getColor(d) {
				return d === undefined ? '#DCDCDC' :
					d > 150 ? '#a50f15' :
						d > 100 ? '#de2d26' :
							d > 50 ? '#fb6a4a' :
								d > 1 ? '#fcae91' :
									'#fee5d9';
			}

			function getColor_income(d) {
			
				return d === undefined ? '#DCDCDC' :
					d > 125 ? '#54278f' :
						d > 106 ? '#756bb1' :
							d > 91 ? '#9e9ac8' :
								d > 10 ? '#cbc9e2' :
									'#f2f0f7';
			}


			function style(feature) {
				var a = document.getElementById("map_type");
				var val = a.options[a.selectedIndex].value;
				if (val == "Income") {

					return {
						//fillColor: getColor(feature.properties.norm_crime_count),
						fillColor: getColor_income(feature.properties.income),
						weight: 2,
						opacity: 1,
						color: 'grey',
						dashArray: '3',
						fillOpacity: 1
					};
				}
				else {
					return {
						//fillColor: getColor(feature.properties.norm_crime_count),
						fillColor: getColor(feature.properties.norm_crime_count),
						weight: 2,
						opacity: 1,
						color: 'grey',
						dashArray: '3',
						fillOpacity: 1
					};
				}




			}

			// Change chloropleth data based on listbox value 
			document.getElementById("map_type").onchange = function (e) {
				L.geoJson(data, { style: style }).addTo(mymap);
				hover_functionality();
				create_legend();

			}

			L.geoJson(data, { style: style }).addTo(mymap);
			hover_functionality();
			create_legend();
			var geojson;
			var popup = L.popup();

			function highlightFeature(e) {
				var layer = e.target;

				if (layer.feature.properties.crime_count != undefined){
					
					popup
					.setLatLng(e.latlng)
					.setContent('<h4>Neighborhood details</h4>' + 
					'<b>' + layer.feature.properties.name + '</b><br />' + layer.feature.properties.crime_count + ' Crime Count<br />'+ layer.feature.properties.price_per_room+' Avg Price Per Room ($)<br />'
					+ (layer.feature.properties.income*layer.feature.properties.income).toFixed(2) + ' Income ($) <br />')					    .openOn(mymap);
				}

				if (!L.Browser.ie && !L.Browser.opera && !L.Browser.edge) {
					layer.bringToFront();
				}

				info.update(layer.feature.properties);
			}

			function resetHighlight(e) {
				// geojson.resetStyle(e.target);
				mymap.closePopup(popup);
				info.update();
			}

			function zoomToFeature(e) {
			
				var layer = e.target;

				add = true;
				if (layer.feature.properties.crime_count > 0) {
					e_prop = e.target.feature.properties;
					var keys1 = [];
					if (barData.length > 0) {
						keys1 = barData.map(function (d) { return (d.name) });
					}
					if (keys1.indexOf(e_prop.name) != -1) {
						barData.splice(keys1.indexOf(e_prop.name), 1);
						geojson.resetStyle(layer);
						
					}
					else{
						//barData.push(layer.feature.properties);
						barData.push(layer.feature.properties);
						layer.setStyle({
							weight: 2,
							color: '#000',
							dashArray: '',
							fillOpacity: 0.7
						});
						if (barData.length>10){
							barData=barData.slice(1,11);
						}
					}

					replay(barData);
					draw_info(layer.feature.properties);
					draw_pie(layer.feature.properties);
					d3.select("#info-city").text(layer.feature.properties.name);
					remove_markers(markers_listings);
					add_markers(layer.feature.properties.listings,markers_listings);
				}

			};

			function remove_markers(markers_listings){
				for(var i=0;i<markers_listings.length;i++)
				mymap.removeLayer(markers_listings[i]);
			}

			function add_markers(listings,markers_listings){
				// var listings=layer.feature.properties.listings
				for(var i=0;i<listings.length;i++){
					console.log(listings[i])
					// L.marker([listings[i].latitude,listings[i].longitude]).addTo(mymap);
					if (listings[i].room_type=="private_room")
					{
						var circle = L.circle([listings[i].latitude,listings[i].longitude], {
											    color: '#0ECCC7',//blue
											    fillColor: '#0ECCC7',
											    fillOpacity: 0.5,
											    radius: 15
											}).addTo(mymap);
						markers_listings.push(circle);
					}else if (listings[i].room_type=="entire_home_apt")
					{
						var circle = L.circle([listings[i].latitude,listings[i].longitude], {
											    color: '#FF77F2',
											    fillColor: '#FF77F2', 
											    fillOpacity: 0.5,
											    radius: 15
											}).addTo(mymap);
						markers_listings.push(circle);
					}else if (listings[i].room_type=="shared_room")
					{
						var circle = L.circle([listings[i].latitude,listings[i].longitude], {
											    color: '#F5FF0D',
											    fillColor: '#F5FF0D',
											    fillOpacity: 0.5,
											    radius: 15
											}).addTo(mymap);
						markers_listings.push(circle);
					}
				}
			}

			function hover_functionality() {
				var onEachFeature_LMA = function onEachFeature(feature, layer) {

					layer.on({
						mouseover: highlightFeature,
						mouseout: resetHighlight,
						click: zoomToFeature
					});

				};
				geojson = L.geoJson(data, {
					style: style,
					onEachFeature: onEachFeature_LMA
				}).addTo(mymap);
			};

			var info = L.control();

			info.onAdd = function (map) {
				this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
				this.update();
				return this._div;
			};

			// method that we will use to update the control based on feature properties passed
			info.update = function (props) {
				this._div.innerHTML = 'Hover over a state or Click to compare';
			};

			info.addTo(mymap);


			function create_legend() {
				var a = document.getElementById("map_type");
				var val = a.options[a.selectedIndex].value;
				var divs = document.getElementsByTagName('div');
				for ( i = 0; i < divs.length ; i++) {
					if (divs[i].className == "info legend leaflet-control") {
						divs[i].remove();
					}
				}


				var legend = L.control({ position: 'bottomright' });

				if (val === 'Crime') {
					legend.onAdd = function (map) {

						var div = L.DomUtil.create('div', 'info legend'),
							grades = [1, 50, 100, 150],
							labels = [];

						// loop through our density intervals and generate a label with a colored square for each interval
						for (var i = 0; i < grades.length; i++) {
							div.innerHTML +=
								'<i style="background:' + getColor(grades[i] + 1) + '"></i> ' +
								grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
						}

						return div;
					};
				}
				else {
					legend.onAdd = function (map) {
						var div = L.DomUtil.create('div', 'info legend');
						grades = [10, 91, 106, 125],
							labels = [];

						// loop through our density intervals and generate a label with a colored square for each interval
						for (var i = 0; i < grades.length; i++) {
							div.innerHTML +=
								'<i style="background:' + getColor_income(grades[i] + 1) + '"></i> ' +
								grades[i] + (grades[i + 1] ? '&ndash;' + grades[i + 1] + '<br>' : '+');
						}

						return div;
					};
				}

				legend.addTo(mymap);


				
			};
			mymap.createPane('labels');

			mymap.getPane('labels').style.zIndex = 650;

			mymap.getPane('labels').style.pointerEvents = 'none';

			var positronLabels = L.tileLayer('http://{s}.basemaps.cartocdn.com/light_only_labels/{z}/{x}/{y}.png', {
				attribution: '©OpenStreetMap, ©CartoDB',
				pane: 'labels'
			}).addTo(mymap);

			mymap.doubleClickZoom.disable();			properties = data['features'].map(function (d) { return d.properties; });

		});

		var margin = {top: 20, right: 180, bottom: 30, left: 80};
		var width = 1000;
		var height = 550;

		var svg = d3.select(".corr_chart")
						.attr("width", width + margin.left + margin.right)
						.attr("height", height + margin.top + margin.bottom);

		// Mike Bostock "margin conventions"
		// var margin = { top: 20, right: 180, bottom: 30, left: 80 },
		// 	width = 1100 - margin.left - margin.right,
		// 	height = 500 - margin.top - margin.bottom;

		// D3 scales = just math
		// x is a function that transforms from "domain" (data) into "range" (usual pixels)
		// domain gets set after the data loads
		var x = d3.scaleBand()
			.rangeRound([0, width]).paddingInner(0.1);;

		var x1 = d3.scaleBand().padding(0.05);

		var y = d3.scaleLinear()
			.range([height, 0]);

		var y1 = d3.scaleLinear().range([height, 0]);

		// D3 Axis - renders a d3 scale in SVG
		var xAxis = d3.axisBottom()
			.scale(x);
		// .orient("bottom");

		var yAxis = d3.axisLeft()
			.scale(y);

		var yAxisRight = d3.axisRight().scale(y1);


		var color = d3.scaleOrdinal()
			.range(["#fb6a4a","#9e9ac8","#008000"]); 

		// var svg = d3.select("#corr_chart").append("svg")
		// 	.attr("width", width + margin.left + margin.right)
		// 	.attr("height", height + margin.top + margin.bottom)
		var g = svg.append("g")
			.attr("transform", "translate(" + margin.left + "," + margin.top + ")");

		g.append("g")
			.attr("class", "x axis")
			.attr("transform", "translate(0," + height + ")")

		g.append("g")
			.attr("class", "y axis");

		g.append("g")
			.attr("class", "y axis right")
			.attr("transform", "translate(" + width + ",0)");

		var valueline = d3.line()
		    .x(function(d) { return x(d.name); })
		    .y(function(d) { return y1(d.price_per_room); });

		svg
			.append("text") // just for the title (ticks are automatic)
			.style("font","sans-serif")
			.style("font-size","15px")
			.style("fill","white")
			.attr("transform", "translate(15," +  (height+margin.bottom)/2 + ") rotate(-90)") // rotate the text!
			// .attr("y", 2)
			.attr("dy", ".71em")
			.style("text-anchor", "end")
			.text("Crime Count");;

		svg
			.append("text") // just for the title (ticks are automatic)
			.style("font","sans-serif")
			.style("font-size","15px")
			.attr("transform", "translate(" + (width+150) +  ","+ (height+margin.bottom)/2 + ") rotate(90)") // rotate the text!
			// .attr("y", 2)
			.attr("dy", ".71em")
			.style("fill","white")
			.style("text-anchor", "end")
			.text("Price per room / Income");;

	
		initial_barchart();

		var bar_values=['crime_count','income'];

		function initial_barchart() {

			var data = barData;
			var options = ['crime_count', 'income'];

			data.forEach(function (d) {
				d.valores = options.map(function (name) { return { name1: name, value: +d[name] }; });
			});

			x.domain(data.map(function (d) { return d.name; }));
			x1.domain(['crime_count','income']).rangeRound([0, x.bandwidth()]);
			y.domain([0, d3.max(data, function (d) { return d3.max(d.valores, function (d) { if (d.name1=="crime_count"){ return d.value;} }); })]);
			// y1.domain([0, d3.max(data, function(d) { return d3.max(d.valores, function (d) { if (d.name1=="income"){ return d.value;} }); })]);
			y1.domain([0, d3.max(data, function(d) { return d.price_per_room; })]);

			svg.select('.x.axis').transition().duration(300).call(xAxis);

			// // same for yAxis but with more transform and a title
			svg.select(".y.axis").transition().duration(300).call(yAxis);

			svg.select(".y.axis.right").transition().duration(300).call(yAxisRight);

			// Add the valueline path.


			var bars = g.selectAll(".bar")
				.data(data);

			bars.enter().append("g")
				.attr("class", "bar").transition()
				.duration(300)
				.attr("transform", function (d) { return "translate(" + x(d.name) + ",0)"; });

			var bar_rects = g.selectAll(".bar").selectAll("rect").data(function (d) { return d.valores; });

			bar_rects
				.enter().append("rect")
				.attr("class", function(d){if (d.name1=="crime_count"){return "rect_crime";}else if(d.name1=="income"){return "rect_income";}})
				.attr("stroke-width", 4)
				.style("opacity",1)
				.on("mousemove", function (d) {

				    d3.select("#tooltip-chart")
				        .style("left", d3.event.pageX + "px")
				        .style("top", d3.event.pageY + "px")
				        .style("opacity", 1)
				        .style("visibility","visible")
				        .html( d.name1=="income"? (d.name1).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(((d.value)*(d.value)).toFixed(2))+" ($) "
						: (d.name1).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(d.value));

				})
	            .on("mouseout", function () {
				    // Hide the tooltip
				    d3.select("#tooltip-chart")
				    .style("visibility","visible")
				        .style("opacity", 0);
				})
				.transition()
				.duration(300)
				.attr("x", function (d) {
					return x1(d.name1);
				})
				.attr("width", x1.bandwidth())
				.attr("y", function (d) { if (d.name1=="crime_count"){return y(d.value);} 
					else {
						if (d.name1=="income"){return y1(d.value);}}
					 })
				.attr("value", function (d) {
					return d.name1;
				})
				.attr("height", function (d) { if (d.name1=="crime_count"){return height - y(d.value);}
					else{
						if (d.name1=="income"){
							return height - y1(d.value);
						}
					}
					 })
				.style("fill", function (d) { 
					return color(d.name1);
				});

				g.append("path")
				  .data([data])
				  .attr("class", "line")
				  .attr("d", valueline)
				  .attr("transform", "translate(" + (x1.bandwidth()+10) + "," + 0 + ")");

				 g.selectAll("dot")	
			        .data(data)			
			    .enter().append("circle")								
			        .attr("r", 5)		
			        .attr("cx", function(d) { return x(d.name) + x1.bandwidth() + 10; })		 
			        .attr("cy", function(d) { return y1(d.price_per_room); })
			        .attr("class","dot")
			        .style("fill","#008000")
			        .on("mouseover", function (d) {

					    d3.select("#tooltip-chart")
					        .style("left", d3.event.pageX + "px")
					        .style("top", d3.event.pageY + "px")
					        .style("opacity", 1)
					        .style("visibility","visible")
					        .html("Price per room:<br>"+(d.price_per_room)+" ($)");

					})
		            .on("mouseout", function () {
					    // Hide the tooltip
					    d3.select("#tooltip-chart")
					    .style("visibility","visible")
					        .style("opacity", 0);
					});
				  
					    // Legend
				var legend = svg.selectAll(".legend")
				    .data(['Price per room','Crime count','Income'].slice())
				    .enter()
				    .append("g")
				      .attr("class", "legend")
				      .attr("transform", function(d, i) { return "translate(250," + (i+1) * 20 + ")"; });

				legend.append("rect")
				    .attr("x", width - 48)
				    .attr("class","legend")
				    .attr("id",function(d){ if (d=="Crime count"){return "crime_id";}else if(d=="Income"){return "income_id";}})
				    .attr("width", 18)
				    .attr("height", 18)
				    .style("fill", color)
				    .style("opacity",1)
				    .on("click", function(){
						// Determine if current line is visible
						var id   = d3.select(this).attr("id");
						if (id=="crime_id"){
							var opacity = d3.select("#crime_id").style("opacity");
						  	if (opacity==1){
						  		d3.select("#crime_id").style("opacity", 0.5);

						  		bar_values = bar_values.slice(bar_values.indexOf('crime_count')+1,bar_values.indexOf('crime_count')+2);

						  		draw(barData,bar_values);
						  	} else{
						  		bar_values.push("crime_count");
						  		bar_values.sort();
						  		d3.select("#crime_id").style("opacity", 1);
						  		draw(barData,bar_values);
						  	}
						}else if (id=="income_id"){
							var opacity = d3.select("#income_id").style("opacity");
						  	if (opacity==1){
						  		
						  		d3.select("#income_id").style("opacity", 0.5);
						  		
						  		bar_values = bar_values.slice(0,bar_values.indexOf('income'));
						  		
						  		draw(barData,bar_values);
						  	}else{
						  		bar_values.push("income");
						  		bar_values.sort();
						  		
						  		d3.select("#income_id").style("opacity", 1);
						  		draw(barData,bar_values);
						  	}
						}
					});

				legend.append("text")
					.attr("class","legend-bar")
				    .attr("x", width - 54)
				    .attr("y", 9)
				    .attr("dy", ".35em")
				    .style("text-anchor", "end")
				    .text(function(d) { return d; });



				}

		function replay(data) {

			var options = ['crime_count', 'income','price_per_room'];

			data.forEach(function (d) {
				d.valores = options.map(function (name) { return { name1: name, value: +d[name] }; });
			});

			draw(data, bar_values);
		}

		function draw(data, bar_values=['crime_count', 'income']) {

			x.domain(data.map(function (d) { return d.name; }));
			x1.domain(bar_values).rangeRound([0, x.bandwidth()]);

			y.domain([0, d3.max(data, function (d) { return d3.max(d.valores, function (d) { 
			
					if (d.name1=="crime_count"){ return d.value;}
				
				 }); })]);
				

			y1.domain([0, d3.max(data, function(d) { return d.price_per_room; })]);


			svg.select('.x.axis').transition().duration(300).call(xAxis);

			// // same for yAxis but with more transform and a title
			svg.select(".y.axis").transition().duration(300).call(yAxis);

			svg.select(".y.axis.right").transition().duration(300).call(yAxisRight);

			var bars = g.selectAll(".bar")
				.data(data);

			bars.transition()
				.duration(300)
				.attr("transform", function (d) {  return "translate(" + x(d.name) + ",0)"; });

			bars.enter().append("g")
				.attr("class", "bar").transition()
				.duration(300)
				.attr("transform", function (d) {  return "translate(" + x(d.name) + ",0)"; });

			bars.exit()
				.transition()
				.duration(300)
				.style('fill-opacity', 1e-6)
				.remove();

			g.selectAll(".line").remove();
			g.selectAll(".dot").remove();

			var bar_rects = g.selectAll(".bar").selectAll("rect").data(function (d) { return d.valores; });

			bar_rects.attr("stroke-width", 4)
				.on("mousemove", function (d) {	
				    d3.select("#tooltip-chart")
				        .style("left", d3.event.pageX + "px")
				        .style("top", d3.event.pageY + "px")
				        .style("opacity", 1)
				        .style("visibility","visible")
				        .html( d.name1=="income"? (d.name1).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(((d.value)*(d.value)).toFixed(2))+" ($) "
						: (d.name1).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(d.value));

				})
	            .on("mouseout", function () {
				    // Hide the tooltip
				    d3.select("#tooltip-chart")
				    .style("visibility","visible")
				        .style("opacity", 0);
				})
				.transition()
				.duration(300)
				.attr("x", function (d) {  return x1(d.name1); })
				.attr("width", x1.bandwidth())
				.attr("y", function (d) { 
					if( bar_values.indexOf("crime_count")>-1){
						if (d.name1=="crime_count"){
							return y(d.value);
						}
					}
					if( bar_values.indexOf("income")>-1){
							if(d.name1=="income"){
								return y1(d.value);
							}
						}
						
				
				})
				.attr("value", function (d) { return d.name1; })
				.attr("height", function (d) { i
					if( bar_values.indexOf("crime_count")>-1){
						if (d.name1=="crime_count"){
							return height - y(d.value);
						}
					}
					
						if( bar_values.indexOf("income")>-1){
							if(d.name1=="income"){
								return height - y1(d.value);
							}
						}
					
					 })
				.style("fill", function (d) { return color(d.name1); });
			

			bar_rects
				.enter().append("rect")
				.attr("class", "rect")
				.attr("stroke-width", 4)
				.on("mousemove", function (d) {
				
				    d3.select("#tooltip-chart")
				        .style("left", d3.event.pageX + "px")
				        .style("top", d3.event.pageY + "px")
				        .style("opacity", 1)
				        .style("visibility","visible")
				        .html((d.name1).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(d.value));

				})
	            .on("mouseout", function () {
				    // Hide the tooltip
				    d3.select("#tooltip-chart")
				    .style("visibility","visible")
				        .style("opacity", 0);
				})
				.transition()
				.duration(300)
				.attr("x", function (d) {  return x1(d.name1); })
				.attr("width", x1.bandwidth())
				.attr("y", function (d) { 
					if( bar_values.indexOf("crime_count")>-1){
						if (d.name1=="crime_count"){
							return y(d.value);
						}
					}
						if( bar_values.indexOf("income")>-1){
							if(d.name1=="income"){
								return y1(d.value);
							}
						}
					
				})
				.attr("value", function (d) { return d.name1; })
				.attr("height", function (d) { 
					if( bar_values.indexOf("crime_count")>-1){
						if (d.name1=="crime_count"){
							return height - y(d.value);
						}
					}
						if( bar_values.indexOf("income")>-1){
							if(d.name1=="income"){
								return height - y1(d.value);
							}
						}
					
					 })
				.style("fill", function (d) { return color(d.name1); });


			g.append("path")
				  .data([data])
				  .attr("class", "line")
				  .attr("d", valueline)
				  .attr("transform", "translate(" + (x1.bandwidth()+5) + "," + 0 + ")");;
			
			 g.selectAll("dot")	
			        .data(data)			
			    .enter().append("circle")								
			        .attr("r", 5)		
			        .attr("cx", function(d) { return x(d.name) + x1.bandwidth() + 5; })		 
			        .attr("cy", function(d) { return y1(d.price_per_room); })
			        .attr("class","dot")
			        .style("fill","#008000")
			        .on("mouseover", function (d) {
		
					    d3.select("#tooltip-chart")
					        .style("left", d3.event.pageX + "px")
					        .style("top", d3.event.pageY + "px")
					        .style("opacity", 1)
					        .style("visibility","visible")
					        .html("Price per room:<br>"+(d.price_per_room));

					})
		            .on("mouseout", function () {
					    // Hide the tooltip
					    d3.select("#tooltip-chart")
					    .style("visibility","visible")
					        .style("opacity", 0);
					});

			bar_rects.exit()
				.transition()
				.duration(300)
				.style('fill-opacity', 1e-6)
				.remove();
  
}


		var margin_info = {top: 20, right: 20, bottom: 150, left: 50};
		var width_info = 200;
		var height_info = 150;

		var chart_info = d3.select(".chart")
						.attr("width", width_info + margin_info.left + margin_info.right)
						.attr("height", height_info + margin_info.top + margin_info.bottom)
						.append("g")
						.attr("transform", "translate(" + margin_info.left + "," + margin_info.top + ")");

		var xChart_info = d3.scaleBand()
						.range([0, width_info]);
						
		var yChart_info = d3.scaleLinear()
						.range([height_info, 0]);

		var xAxis_info = d3.axisBottom(xChart_info);
		var yAxis_info = d3.axisLeft(yChart_info);

		//set up axes
		//left axis
			chart_info.append("g")
				  .attr("class", "y axis info")
				  .call(yAxis_info)
				  
			//bottom axis
			chart_info.append("g")
				.attr("class", "xAxis info")
				.style("font","sans-serif")
				.style("font-size","10px")
				.attr("transform", "translate(0," + height_info + ")")
				.call(xAxis_info)
				.selectAll("text")
					.style("text-anchor", "end")
					.attr("dx", "-.8em")
					.attr("dy", ".15em")
					.attr("transform", function(d){
						return "rotate(-90)";
					});

		//add labels
		chart_info
			.append("text")
			.style("font","sans-serif")
			.style("font-size","10px")
			.attr("transform", "translate(-35," +  (height_info+margin_info.bottom)/2 + ") rotate(-90)")
			.text("Crime rate");
				
		chart_info
			.append("text")
			.style("font","sans-serif")
			.style("font-size","10px")
			.attr("transform", "translate(" + (width_info/2) + "," + (height_info + margin_info.bottom - 5) + ")")
			.text("Crime type");

		draw_info(infoData);

		function draw_info(values){

			var data = [];
					
			var crime_types = ["arson", "burglary", "federal_offenses", "felonies_miscellaneous", "fraud_and_nsf_checks", "grand_theft_auto", "larceny_theft", "narcotics", "rape", "robbery", "sex_offenses"];
			for (var key in values) {
				if (crime_types.indexOf(key) > -1) {
					data.push({ name: key, value: values[key] });
				}
			}
			//set domain for the x axis
			xChart_info.domain(data.map(function(d){ return (d.name).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase()); }) );
			//set domain for y axis
			yChart_info.domain( [0, d3.max(data, function(d){ return +d.value; })] );
			
			//get the width of each bar 
			var barWidth = width_info / data.length;
			
			//select all bars on the graph, take them out, and exit the previous data set. 
			//then you can add/enter the new data set
			var bars_info = chart_info.selectAll(".bar_info")
							.remove()
							.exit()
							.data(data)		
			//now actually give each rectangle the corresponding data
			bars_info.enter()
				.append("rect")
				.attr("class", "bar_info")
				.attr("x", function(d, i){ return i * barWidth + 1 })
				.attr("y", function(d){ return yChart_info( d.value); })
				.attr("height", function(d){ return height_info - yChart_info(d.value); })
				.attr("width", barWidth - 1)
				.attr("fill", function(d){ 
						return "#FF8E3E";
				})
				.on("mousemove", function (d) {
				
				    d3.select("#tooltip-bar")
				        .style("left", d3.event.pageX + "px")
				        .style("top", d3.event.pageY + "px")
				        .style("opacity", 1)
				        .style("visibility","visible")
				        .html((d.name).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(d.value));
				})
	            .on("mouseout", function () {
				    // Hide the tooltip
				    d3.select("#tooltip-bar")
				    .style("visibility","hidden")
				        .style("opacity", 0);
				});
			//left axis
			chart_info.select('.y.info')
				  .call(yAxis_info)
			//bottom axis
			chart_info.select('.xAxis.info')
				.attr("transform", "translate(0," + height_info + ")")
				.call(xAxis_info)
				.selectAll("text")
					.style("text-anchor", "end")
					.style("fill","white")
					.attr("dx", "-.8em")
					.attr("dy", ".15em")
					.attr("transform", function(d){
						return "rotate(-90)";
					});
		}

		var width_pie = 250,
		    height_pie = 250,
		    radius_pie = Math.min(width_pie, height_pie) / 2;

		// var color_pie = d3.scaleOrdinal(d3.schemeCategory10);

		var pie = d3.pie()
		    .value(function(d) { return d.value; })
		    .sort(null);

		var arc_pie = d3.arc()
		    .innerRadius(radius_pie - 60)
		    .outerRadius(radius_pie - 20);

		var svg_pie = d3.select("#pie")
		    .attr("width", width_pie)
		    .attr("height", height_pie)
		  .append("g")
		    .attr("transform", "translate(" + width_pie / 2 + "," + height_pie / 2 + ")");

		var path_pie = svg_pie.selectAll("path");

		var color_pie = d3.scaleOrdinal()
			//.range(["#B36FFF","#FFBF2A","#399CB2"]); 
			.range(["#F5FF0D","#0ECCC7 ","#FF77F2"]); 


		draw_pie(infoData);
		

		function draw_pie(values){
			
			pie_data = [];
					
			var room_types = ["shared_room","private_room","entire_home_apt"];
			for (var key in values) {
				if (room_types.indexOf(key) > -1) {
					pie_data.push({ name: key, value: values[key] });
				}
			}



			var g = svg_pie.selectAll('.arc')
			    .data(pie(pie_data))
			    .attr('class', 'arc')
			    .enter().append('g');

			g.selectAll(".pie_text").remove();


			g.append('path')
			    .attr('d', arc_pie)
			    .style('fill', function(d, i) { return color_pie(i); })
				.on("mouseover", function (d) {
					var total = d3.sum(pie_data.map(function(d) {                // NEW
		              return d.value;                                           // NEW
		            }));                                                        // NEW
		            var percent = Math.round(1000 * d.data.value / total) / 10; // NEW
				    d3.select("#tooltip-pie")
				        .style("left", d3.event.pageX + "px")
				        .style("top", d3.event.pageY + "px")
				        .style("opacity", 1)
				        .style("visibility","visible")
				        .html((d.data.name).replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase())+"<br>"+(d.data.value));
				})
	            .on("mouseout", function () {
				    // Hide the tooltip
				    d3.select("#tooltip-pie")
				    .style("visibility","hidden")
				        .style("opacity", 0);
				});


			 g.append("text")
		      .attr("transform", function(d) { //set the label's origin to the center of the arc
		        //we have to make sure to set these before calling arc.centroid
		        d.outerRadius = radius_pie - 20; // Set Outer Coordinate
		        d.innerRadius = radius_pie - 60; // Set Inner Coordinate
		        return "translate(" + arc_pie.centroid(d) + ")";
		      })
		      .attr("class","pie_text")
		      .attr("text-anchor", "middle") //center the text on it's origin
		      .style("fill", "black")
		      .style("font", "bold 12px Arial")
		       .text(function(d, i) { if (d.data.value>0){
				var total = d3.sum(pie_data.map(function(d) {                // NEW
		              return d.value;                                           // NEW
		            }));                                                        // NEW
		             var percent = Math.round(1000 * d.data.value / total) / 10;
			  return((percent)+"%");} }); 

			var legendRectSize = 18;
        	var legendSpacing = 4;

			var legend_pie = svg_pie.selectAll('.legend_pie')
	            .data(["Shared Room","Private Room","Entire Home Apt"])
	            .enter()
	            .append('g')
	            .attr('class', 'legend_pie')
	            .attr('transform', function(d, i) {
	              var height = legendRectSize + legendSpacing;
	              var offset =  height_pie * color_pie.domain().length/5;
	              var horz = -2 * legendRectSize;
	              var vert = 22 * i - 30;
	              return 'translate(' + horz + ',' + vert + ')';
	            });

			legend_pie.append('rect')
			.attr('width', legendRectSize)
			.attr('height', legendRectSize)                                   
			.style('fill', color_pie)
			.style('stroke', color_pie);

			legend_pie.append('text')
	            .attr('x', legendRectSize + legendSpacing)
	            .attr('y', legendRectSize - legendSpacing)
	            .text(function(d) { return d; });

		}

		

		
	</script>
	 <script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
    <script src="https://cdn.rawgit.com/twbs/bootstrap/v4-dev/dist/js/bootstrap.js"></script>
</body>

</html>